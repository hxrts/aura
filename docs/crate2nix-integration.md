# Aura crate2nix Integration Guide

This document describes the crate2nix integration added to the Aura project for hermetic, reproducible Nix builds.

## Overview

**crate2nix** is a tool that generates Nix expressions from Cargo-based Rust projects, enabling hermetic builds where all dependencies are explicitly fetched and pinned with cryptographic hashes.

**Benefits for Aura:**
- **Hermetic builds**: All dependencies are pre-fetched and cached with hashes
- **Per-crate granularity**: Each crate becomes a separate Nix derivation for efficient caching
- **Git dependency handling**: The `quint_evaluator` git dependency is properly managed
- **CI efficiency**: Binary cache can store individual crate builds
- **Reproducibility**: Bit-for-bit identical builds across environments

## Implementation

### 1. Flake Configuration

The `flake.nix` has been updated with:

```nix
inputs = {
  # ... existing inputs ...
  crate2nix = {
    url = "github:timewave-computer/crate2nix";
    inputs.nixpkgs.follows = "nixpkgs";
  };
};
```

**Key features:**
- Uses the timewave-computer fork (actively maintained)
- Imports generated `Cargo.nix` file
- Provides crate overrides for system dependencies
- Handles macOS-specific build requirements

### 2. Package Structure

**Available packages:**
- `nix build .#aura-cli` - Main CLI application
- `nix build .#aura-agent` - Agent daemon
- `nix build .#aura-simulator` - Simulation framework
- `nix build .#regenerate-cargo-nix` - Helper script

**Available checks:**
- `nix build .#aura-core-tests` - Core library tests
- `nix build .#aura-crypto-tests` - Cryptography tests
- `nix build .#aura-protocol-tests` - Protocol tests

### 3. Crate Overrides

Platform-specific dependencies are handled via crate overrides:

```nix
defaultCrateOverrides = pkgs.defaultCrateOverrides // {
  # System dependencies
  openssl-sys = attrs: {
    buildInputs = [ pkgs.openssl pkgs.pkg-config ];
  };
  
  # macOS-specific fixes
  blake3 = attrs: {
    buildInputs = pkgs.lib.optionals pkgs.stdenv.isDarwin [
      pkgs.libiconv
    ];
  };
  
  # Additional overrides for crypto crates...
};
```

## Usage

### Development Workflow

**1. Generate Cargo.nix (when dependencies change):**
```bash
just generate-cargo-nix
# OR
nix develop --command crate2nix generate
```

**2. Test hermetic builds:**
```bash
just build-nix              # Build aura-cli
just build-nix-package aura-agent  # Build specific package
just test-nix-all           # Test all packages
```

**3. Run hermetic checks:**
```bash
just check-nix
# OR
nix flake check
```

### Regular Development (still available)

The existing cargo-based workflow continues to work:

```bash
just build                  # Normal cargo build
just test                   # Normal cargo test
just check                  # Normal cargo check
```

### When to Regenerate Cargo.nix

**Required when:**
- Adding/removing workspace crates
- Updating dependencies in `Cargo.toml`
- Changing git dependency versions
- Adding new features that affect dependency resolution

**Not required for:**
- Source code changes without dependency changes
- Documentation updates
- Test additions (unless new test dependencies)

## Architecture

### File Structure

```
aura/
├── flake.nix              # Nix flake with crate2nix integration
├── Cargo.nix              # Generated by crate2nix (800KB+)
├── crate-hashes.json       # Dependency hashes (auto-generated)
├── Cargo.toml              # Workspace configuration
└── justfile                # Build automation with Nix commands
```

### Build Process

1. **Metadata Extraction**: crate2nix analyzes `Cargo.toml`/`Cargo.lock`
2. **Dependency Resolution**: Uses cargo's exact dependency resolution
3. **Source Fetching**: Pre-fetches all crates.io and git sources
4. **Hash Generation**: Computes SHA256 hashes for all sources
5. **Nix Expression Generation**: Creates `Cargo.nix` with per-crate derivations

### Caching Strategy

**Per-crate granularity means:**
- Only changed crates rebuild (not entire workspace)
- Binary cache can store intermediate results
- CI builds are significantly faster after initial setup
- Local builds benefit from Nix's build caching

## Known Limitations

### Current Issues

1. **CC Crate Apple Target Detection**: The CC crate (used by ring/blake3) fails on macOS in Nix environments
   - **Status**: CC crate expects "darwin" target OS but Nix reports "macos"
   - **Error**: `invalid Apple target OS macos` in CC crate's target detection
   - **Impact**: Prevents hermetic builds of crypto-dependent crates (ring, blake3)
   - **Attempted Solutions**: 
     - Complex CC crate overrides (failed)
     - MACOSX_DEPLOYMENT_TARGET environment variable (failed)
     - Following causality project pattern with simplified overrides (failed)
   - **Analysis**: Issue persists despite using identical blake3/ring versions as working causality project
   - **Workaround**: Use regular cargo build for development
   - **Future Solution**: Requires investigation of differences between our environment and causality's working environment, or upstream fix in CC crate

2. **Platform Dependencies**: Some crypto crates require careful override configuration
   - **Status**: Basic overrides implemented for most crates
   - **Future**: CC crate issue affects multiple crypto dependencies

### Missing Features

- WebAssembly compilation targets not yet tested
- Cross-compilation scenarios not configured
- Advanced crate feature selection not utilized

## Troubleshooting

### Common Issues

**"Cargo.nix not found"**
```bash
# Generate it first
just generate-cargo-nix
```

**"path does not exist" for ext/quint**
```bash
# Currently known issue - use regular cargo for now
just build  # Instead of just build-nix
```

**Blake3 build failures on macOS**
```bash
# Should be fixed by crate overrides, if not:
nix develop --command cargo build  # Fallback to regular build
```

### Debug Commands

```bash
# Show available packages
nix flake show

# Build with detailed trace
nix build .#aura-cli --show-trace

# Check flake validity
nix flake check --show-trace
```

## Future Improvements

### Short Term
1. Fix quint evaluator path handling
2. Test WebAssembly compilation
3. Add more crate overrides as needed

### Long Term
1. CI integration with binary caching
2. Cross-compilation support
3. Automated Cargo.nix regeneration in CI

## Integration Status

**✅ Completed:**
- crate2nix integration in flake.nix
- Cargo.nix generation working
- Platform-specific crate overrides
- Justfile commands for workflow
- Package structure with checks

**⚠️ Partial:**
- Build process (works for most crates)
- Git dependency handling (needs quint evaluator fix)

**❌ Pending:**
- Full hermetic build success
- CI integration
- Documentation for all edge cases

## See Also

- [crate2nix official documentation](https://github.com/kolloch/crate2nix)
- [Timewave fork features](https://github.com/timewave-computer/crate2nix)
- [Nix Darwin framework migration guide](https://nixos.org/manual/nixpkgs/stable/#sec-darwin-legacy-frameworks)