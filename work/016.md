# Work Plan 016 - Layer 4 Safety + Maintainability Fixes

## Goals
- Remove unsafe fallbacks and panics in Layer 4 bridges/facts
- Make guard and consensus orchestration safer and more testable
- Move moderation facts out of `aura-protocol` into a domain crate
- Reduce async blocking and state corruption risks

## Tasks
- [x] 1) Make `TypedHandlerBridge` fail-closed and remove thread-local context (explicit context storage / task-safe access)
- [x] 2) Fix persistent sync index hashing and replace blocking locks in persistent sync handler
- [x] 3) Introduce typed/constant Biscuit metadata access in guard chain
- [x] 4) Make relational consensus orchestration accept injected effects (remove direct `RealRandomHandler`/`PhysicalTimeHandler` usage)
- [x] 5) Move moderation facts/query/reducers from `aura-protocol` into `aura-social`, update imports and registrations
- [x] 6) Replace serialization panics in moderation facts + AMP channel membership fact
- [ ] 7) Split `aura-protocol` into sub-crates (`aura-guards`, `aura-consensus`, `aura-amp`, `aura-bridge`, `aura-anti-entropy`) with clean public APIs
- [ ] 8) Move generic anti-entropy orchestration from `aura-protocol::sync` into new `aura-anti-entropy` crate; update dependencies and tests
- [x] 9) Enforce pure decision logic + effectful interpreter separation across orchestration modules
- [x] 10) Sweep Layer 4 for silent fallbacks (`unwrap_or_default`, `unwrap_or(min)`, etc.) and convert to explicit errors
- [x] 11) Strengthen invariants at type level (e.g., `WitnessSet`, `ConsensusConfig` constructors enforce non-empty/quorum)
- [x] 12) Replace stringly-typed operation IDs with enums/newtypes in guards/authorization paths
- [x] 13) Ban std sync locks in async Layer 4 code; enforce via lint/CI check
- [x] 14) Add property tests for guard-chain invariants (charge-before-send, no-observable-without-auth)
- [x] 15) Add state-machine tests for consensus message ordering permutations
- [x] 16) Reduce `aura-protocol` re-exports to discourage downstream coupling to internals
