<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Aura WASM Test</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                margin-bottom: 10px;
                font-size: 2.5rem;
            }

            .header p {
                opacity: 0.9;
                font-size: 1.1rem;
            }

            .main-content {
                padding: 30px;
            }

            .panel {
                background: #f8f9fa;
                border-radius: 10px;
                padding: 25px;
                margin-bottom: 20px;
                border: 1px solid #e9ecef;
            }

            .panel h2 {
                color: #495057;
                margin-bottom: 20px;
                font-size: 1.5rem;
            }

            .status {
                display: inline-block;
                padding: 8px 16px;
                border-radius: 5px;
                font-weight: bold;
                margin-bottom: 20px;
            }

            .status.loading {
                background: #ffc107;
                color: #333;
            }

            .status.ready {
                background: #28a745;
                color: white;
            }

            .status.error {
                background: #dc3545;
                color: white;
            }

            .button-group {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            button {
                background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 1rem;
                cursor: pointer;
                transition:
                    transform 0.2s,
                    box-shadow 0.2s;
                font-weight: 500;
            }

            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
            }

            button:active {
                transform: translateY(0);
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            .output {
                background: #1e1e1e;
                color: #d4d4d4;
                padding: 20px;
                border-radius: 8px;
                font-family: "Courier New", monospace;
                font-size: 0.9rem;
                line-height: 1.6;
                min-height: 200px;
                max-height: 400px;
                overflow-y: auto;
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            .output-line {
                margin: 5px 0;
            }

            .output-line.info {
                color: #4fc3f7;
            }

            .output-line.success {
                color: #66bb6a;
            }

            .output-line.error {
                color: #ef5350;
            }

            .footer {
                text-align: center;
                padding: 20px;
                color: #6c757d;
                font-size: 0.9rem;
            }

            .info-box {
                background: #e3f2fd;
                border-left: 4px solid #2196f3;
                padding: 15px;
                margin-bottom: 20px;
                border-radius: 5px;
            }

            .info-box h3 {
                color: #1976d2;
                margin-bottom: 10px;
            }

            .info-box p {
                color: #424242;
                line-height: 1.6;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Aura Datafrog WASM Test</h1>
                <p>Testing Datalog queries compiled to WebAssembly</p>
            </div>

            <div class="main-content">
                <div class="panel">
                    <h2>WASM Module Status</h2>
                    <div id="status" class="status loading">Loading...</div>
                    <div id="statusMessage"></div>
                </div>

                <div class="info-box">
                    <h3>About This Test</h3>
                    <p>
                        This page demonstrates Datafrog (a Datalog engine)
                        running in WebAssembly. Datafrog will be used in Aura's
                        distributed database for querying the social graph,
                        capability delegations, and neighborhood data with
                        efficient incremental computation.
                    </p>
                </div>

                <div class="panel">
                    <h2>Query Tests</h2>
                    <div class="button-group">
                        <button
                            id="btnTransitive"
                            onclick="runTransitiveClosure()"
                        >
                            Run Transitive Closure
                        </button>
                        <button
                            id="btnFriendOfFriend"
                            onclick="runFriendOfFriend()"
                        >
                            Run Friend-of-Friend Query
                        </button>
                        <button id="btnClear" onclick="clearOutput()">
                            Clear Output
                        </button>
                    </div>
                </div>

                <div class="panel">
                    <h2>Query Results</h2>
                    <div id="output" class="output">
                        <div class="output-line info">
                            Waiting for WASM module to load...
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                Aura Project - Distributed Database Test | Datafrog + WASM
            </div>
        </div>

        <script type="module">
            import init, { DatafrogEngine } from "./pkg/aura_db_test.js";

            let engine = null;
            let output = document.getElementById("output");
            let status = document.getElementById("status");
            let statusMessage = document.getElementById("statusMessage");

            function log(message, type = "info") {
                const line = document.createElement("div");
                line.className = `output-line ${type}`;
                line.textContent = message;
                output.appendChild(line);
                output.scrollTop = output.scrollHeight;
            }

            async function initWasm() {
                try {
                    log("Initializing WASM module...", "info");
                    await init();

                    engine = new DatafrogEngine();

                    status.textContent = "Ready";
                    status.className = "status ready";
                    statusMessage.innerHTML =
                        '<p style="color: #28a745; margin-top: 10px;">Datafrog WASM module loaded successfully!</p>';

                    log("WASM module initialized successfully", "success");
                    log("Datafrog engine ready for queries", "success");
                    log("", "info");

                    enableButtons();
                } catch (error) {
                    status.textContent = "Error";
                    status.className = "status error";
                    statusMessage.innerHTML = `<p style="color: #dc3545; margin-top: 10px;">Failed to load WASM module: ${error.message}</p>`;

                    log(`Error loading WASM: ${error.message}`, "error");
                    log(
                        "Make sure to build the WASM module first with: just build-wasm-db-test",
                        "error",
                    );
                }
            }

            function enableButtons() {
                document.getElementById("btnTransitive").disabled = false;
                document.getElementById("btnFriendOfFriend").disabled = false;
                document.getElementById("btnClear").disabled = false;
            }

            window.runTransitiveClosure = function () {
                if (!engine) {
                    log("Engine not initialized", "error");
                    return;
                }

                log("", "info");
                log("Running transitive closure query...", "info");
                log("Input: edges A->B, B->C, C->D, A->C", "info");
                log("", "info");

                try {
                    const results = engine.run_transitive_closure();
                    log("Query complete:", "success");
                    results.split("\n").forEach((line) => {
                        if (line.trim()) {
                            log("  " + line, "success");
                        }
                    });
                } catch (error) {
                    log(`Error: ${error.message}`, "error");
                }
            };

            window.runFriendOfFriend = function () {
                if (!engine) {
                    log("Engine not initialized", "error");
                    return;
                }

                log("", "info");
                log("Running friend-of-friend query...", "info");
                log(
                    "Social graph: Alice->Bob->Carol->Dave, Alice->Eve->Frank",
                    "info",
                );
                log("", "info");

                try {
                    const results = engine.run_friend_of_friend();
                    log("Query complete:", "success");
                    results.split("\n").forEach((line) => {
                        if (line.trim()) {
                            log("  " + line, "success");
                        }
                    });
                } catch (error) {
                    log(`Error: ${error.message}`, "error");
                }
            };

            window.clearOutput = function () {
                output.innerHTML = "";
                if (engine) {
                    engine.clear();
                }
                log("Output cleared", "info");
            };

            // Initialize WASM on page load
            initWasm();

            // Disable buttons initially
            document.getElementById("btnTransitive").disabled = true;
            document.getElementById("btnFriendOfFriend").disabled = true;
            document.getElementById("btnClear").disabled = true;
        </script>
    </body>
</html>
