# CRDT Choreographic Integration Scenario
# Tests session-type-based CRDT operations using choreographic protocols

[metadata]
name = "crdt_choreographic_integration"
description = "Integration test for session-type-based CRDT operations with choreographic coordination"
version = "0.1.0"
author = "Aura Team"
tags = ["integration", "crdt", "choreography"]

[setup]
participants = 5
threshold = 5
seed = 12345

[network]
latency_range = [15, 100]
drop_rate = 0.05

# Phase 1: Initialize CRDT replicas
[[phases]]
name = "initialization"
description = "Set up journal CRDT state on all participants"
timeout_seconds = 5
actions = [
    { type = "run_choreography", choreography = "crdt_init", participants = ["Replica1", "Replica2", "Replica3", "Replica4", "Replica5"] }
]

# Phase 2: Operation broadcast via choreography
[[phases]]
name = "operation_broadcast"
description = "Test CmRDT operation broadcast using session-type choreography"
timeout_seconds = 10
actions = [
    { type = "run_choreography", choreography = "journal_broadcast", participants = ["Replica1", "Replica2", "Replica3", "Replica4", "Replica5"] },
    { type = "verify_property", property = "causal_delivery", expected = true }
]

# Phase 3: Concurrent operations test
[[phases]]
name = "concurrent_operations"
description = "Test commutativity under concurrent operations"
timeout_seconds = 15
actions = [
    { type = "run_choreography", choreography = "concurrent_ops", participants = ["Replica1", "Replica2", "Replica3", "Replica4", "Replica5"] },
    { type = "verify_property", property = "convergence", expected = true }
]

# Phase 4: Repair protocol test
[[phases]]
name = "repair_protocol"
description = "Test missing operation repair using session-type choreography"
timeout_seconds = 10
actions = [
    { type = "run_choreography", choreography = "journal_repair", participants = ["Replica1", "Replica5"] },
    { type = "verify_property", property = "repair_convergence", expected = true }
]

# Phase 5: Anti-entropy protocol test
[[phases]]
name = "anti_entropy"
description = "Test CvRDT anti-entropy using choreographic state exchange"
timeout_seconds = 8
actions = [
    { type = "run_choreography", choreography = "anti_entropy", participants = ["Replica2", "Replica4"] },
    { type = "verify_property", property = "state_convergence", expected = true }
]

[[properties]]
name = "causal_delivery"
description = "Operations delivered in causal order"
property_type = "safety"

[[properties]]
name = "convergence"
description = "All replicas converge to same state"
property_type = "liveness"

[[properties]]
name = "repair_convergence"
description = "Repair completes successfully"
property_type = "liveness"

[[properties]]
name = "state_convergence"
description = "State converges after anti-entropy"
property_type = "liveness"
