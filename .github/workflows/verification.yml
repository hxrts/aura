name: Verification

on:
  push:
    branches: [main]
    paths:
      - 'verification/**'
      - 'crates/aura-protocol/src/consensus/**'
      - 'crates/aura-journal/**'
      - 'crates/aura-core/src/time/**'
  pull_request:
    branches: [main]
    paths:
      - 'verification/**'
      - 'crates/aura-protocol/src/consensus/**'
      - 'crates/aura-journal/**'
      - 'crates/aura-core/src/time/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Quint Model Checking
  # ─────────────────────────────────────────────────────────────────────────────

  quint-typecheck:
    name: Quint Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-quint
      - uses: ./.github/actions/setup-just
      - run: just ci-quint-typecheck

  quint-verify:
    name: Quint Verify
    runs-on: ubuntu-latest
    needs: quint-typecheck
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-quint
      - uses: ./.github/actions/setup-just
      - run: just ci-quint-verify

  # ─────────────────────────────────────────────────────────────────────────────
  # Lean Formal Verification
  # ─────────────────────────────────────────────────────────────────────────────

  lean:
    name: Lean
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
        with:
          cache-name: lean
      - uses: ./.github/actions/setup-just
      - name: Build Lean proofs
        run: nix develop --command just ci-lean-build
      - name: Check for incomplete proofs
        run: nix develop --command just ci-lean-check-sorry

  # ─────────────────────────────────────────────────────────────────────────────
  # Kani Bounded Model Checking
  # ─────────────────────────────────────────────────────────────────────────────

  kani:
    name: Kani
    runs-on: ubuntu-latest
    # Only run on push to main or when 'kani' label is added
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'kani')
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
        with:
          cache-name: kani
      - uses: ./.github/actions/setup-rust
        with:
          toolchain: nightly
          components: rust-src
      - uses: ./.github/actions/setup-just
      - name: Install CBMC
        run: sudo apt-get update && sudo apt-get install -y cbmc
      - name: Install Kani
        run: |
          cargo install --locked kani-verifier
          cargo kani setup
      - name: Run Kani proofs
        run: just ci-kani
      - name: Upload Kani results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kani-results
          path: kani-output.log
          if-no-files-found: ignore
