name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Fast checks (run first for quick feedback)
  # ─────────────────────────────────────────────────────────────────────────────

  book:
    name: Book
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
        with:
          cache-name: book
      - uses: ./.github/actions/setup-just
      - name: Build documentation
        run: nix develop --command just ci-book

  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
      - uses: ./.github/actions/setup-just
      - run: just ci-format

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
        with:
          components: clippy
      - uses: ./.github/actions/setup-just
      - run: just ci-clippy

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
      - uses: ./.github/actions/setup-just
      - run: just ci-build

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
      - uses: ./.github/actions/setup-just
      - uses: ./.github/actions/setup-quint
      - run: just ci-test

  effects:
    name: Effects Violations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep
      - uses: ./.github/actions/setup-just
      - run: just ci-effects

  doc-links:
    name: Doc Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.github/config/markdown-link-check.json'
          base-branch: 'main'

  # ─────────────────────────────────────────────────────────────────────────────
  # Optional checks (warnings only)
  # ─────────────────────────────────────────────────────────────────────────────

  unused-deps:
    name: Unused Deps
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-rust
        with:
          toolchain: nightly
      - name: Install cargo-udeps
        run: cargo install cargo-udeps --locked
      - run: cargo +nightly udeps --all-targets 2>&1 | grep -E "^(unused|warning:)" || echo "No unused dependencies found"
