name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Suppress Nix welcome message in CI
  AURA_SUPPRESS_NIX_WELCOME: 1

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Fast checks (run first for quick feedback)
  # ─────────────────────────────────────────────────────────────────────────────

  book:
    name: Book
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
        with:
          cache-name: book
      - name: Build documentation
        run: nix develop --command just ci-book

  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
        with:
          cache-name: format
      - run: nix develop --command just ci-format

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
        with:
          cache-name: clippy
      - run: nix develop --command just ci-clippy

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
        with:
          cache-name: build
      - run: nix develop --command just ci-build

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
        with:
          cache-name: test
      - name: Create swap space
        run: |
          # Create 4GB swap for memory-heavy compilation
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap enabled:"
          free -h
      - name: Run tests
        run: nix develop --command just ci-test
        env:
          # Reduce parallelism to lower peak disk usage from concurrent artifacts
          CARGO_BUILD_JOBS: 4
          # Disable debug info to reduce disk usage (~50% reduction in target size)
          CARGO_PROFILE_DEV_DEBUG: 0
          # Disable incremental compilation to reduce disk usage
          CARGO_INCREMENTAL: 0

  effects:
    name: Effects Violations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
        with:
          cache-name: effects
      - run: nix develop --command just ci-effects

  doc-links:
    name: Doc Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: "yes"
          use-verbose-mode: "yes"
          config-file: ".github/config/markdown-link-check.json"
          base-branch: "main"
          folder-path: "docs"

  # ─────────────────────────────────────────────────────────────────────────────
  # Optional checks (warnings only)
  # ─────────────────────────────────────────────────────────────────────────────

  unused-deps:
    name: Unused Deps
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-nix
        with:
          cache-name: unused-deps
      - name: Check unused dependencies
        run: |
          nix develop .#nightly --command bash -c \
            'cargo +nightly udeps --all-targets 2>&1 | grep -E "^(unused|warning:)" || echo "No unused dependencies found"'
